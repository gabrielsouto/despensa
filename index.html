<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Despensa - Cadastro rápido</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        background: #f5f5f5;
        color: #1b1b1b;
      }

      header {
        padding: 1.5rem 1rem;
        background: #222;
        color: #fff;
        text-align: center;
      }

      main {
        flex: 1;
        width: min(960px, 100%);
        margin: 0 auto;
        padding: 1.5rem;
        display: grid;
        gap: 1.5rem;
      }

      section {
        background: #fff;
        border-radius: 12px;
        padding: 1.25rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
      }

      h2 {
        margin-top: 0;
        font-size: 1.25rem;
      }

      #scanner-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
      }

      video {
        width: 100%;
        border-radius: 12px;
        background: #000;
        min-height: 220px;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem;
        align-items: center;
      }

      select,
      input,
      button,
      textarea {
        font: inherit;
        padding: 0.7rem 0.85rem;
        border-radius: 8px;
        border: 1px solid #cfd8dc;
        width: 100%;
      }

      button {
        cursor: pointer;
        background: #0a7cff;
        color: #fff;
        border: none;
        font-weight: 600;
        transition: background 0.2s ease;
      }

      button:hover {
        background: #0058c7;
      }

      form {
        display: grid;
        gap: 1rem;
      }

      label {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        font-size: 0.95rem;
        font-weight: 600;
      }

      .status {
        font-size: 0.9rem;
        color: #555;
      }

      .highlight {
        animation: pulse 0.6s ease;
      }

      @keyframes pulse {
        from {
          box-shadow: 0 0 0 rgba(10, 124, 255, 0.4);
          border-color: #0a7cff;
        }
        to {
          box-shadow: 0 0 0 rgba(10, 124, 255, 0);
          border-color: #cfd8dc;
        }
      }

      .hidden {
        display: none !important;
      }

      @media (max-width: 600px) {
        main {
          padding: 1rem;
        }
      }
    </style>
    <script defer src="https://unpkg.com/@zxing/library@0.20.0"></script>
  </head>
  <body>
    <header>
      <h1>Despensa</h1>
      <p>Escaneie o código de barras e preencha as informações do produto</p>
    </header>

    <main>
      <section id="scanner">
        <h2>Leitor de código de barras</h2>
        <div id="scanner-container">
          <video id="video" playsinline></video>
          <div class="controls">
            <select id="camera-select" aria-label="Escolher câmera"></select>
            <button id="toggle-scan">Iniciar leitura</button>
          </div>
          <div class="status" id="status">Câmera parada</div>
        </div>
      </section>

      <section id="form-section">
        <h2>Cadastro de produto</h2>
        <form id="product-form">
          <label>
            Código de barras
            <input id="barcode" name="barcode" type="text" readonly placeholder="Escaneie um produto" />
          </label>
          <label>
            Nome do produto
            <input id="name" name="name" type="text" autocomplete="off" required />
          </label>
          <label>
            Peso / quantidade
            <input id="weight" name="weight" type="text" placeholder="Ex: 500 g, 2 L" />
          </label>
          <label>
            Embalagem
            <input id="package" name="package" type="text" placeholder="Ex: garrafa PET, pacote" />
          </label>
          <label>
            Foto
            <input id="photo" name="photo" type="file" accept="image/*" capture="environment" />
          </label>
          <button type="submit">Salvar (offline)</button>
        </form>
      </section>
    </main>

    <script>
      const videoElement = document.getElementById("video");
      const cameraSelect = document.getElementById("camera-select");
      const toggleBtn = document.getElementById("toggle-scan");
      const statusEl = document.getElementById("status");
      const barcodeInput = document.getElementById("barcode");
      const form = document.getElementById("product-form");

      let codeReader;
      let scanning = false;
      let currentDeviceId = null;

      async function initDevices() {
        if (!navigator.mediaDevices?.enumerateDevices) {
          statusEl.textContent = "API de câmera não suportada neste navegador.";
          toggleBtn.disabled = true;
          return;
        }

        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter((device) => device.kind === "videoinput");
        cameraSelect.innerHTML = "";

        videoDevices.forEach((device, idx) => {
          const option = document.createElement("option");
          option.value = device.deviceId;
          option.textContent = device.label || `Câmera ${idx + 1}`;
          cameraSelect.appendChild(option);
        });

        if (videoDevices.length === 0) {
          const option = document.createElement("option");
          option.textContent = "Nenhuma câmera encontrada";
          cameraSelect.appendChild(option);
          toggleBtn.disabled = true;
        } else {
          currentDeviceId = videoDevices[0].deviceId;
        }
      }

      async function startScanner() {
        if (!codeReader) {
          codeReader = new ZXing.BrowserMultiFormatReader();
        }
        statusEl.textContent = "Iniciando câmera...";

        try {
          scanning = true;
          toggleBtn.textContent = "Parar leitura";
          await codeReader.decodeFromVideoDevice(currentDeviceId, videoElement, (result, err) => {
            if (result) {
              barcodeInput.value = result.getText();
              statusEl.textContent = `Código detectado: ${result.getText()}`;
              highlightInput(barcodeInput);
              stopScanner();
            }

            if (err && !(err instanceof ZXing.NotFoundException)) {
              console.warn(err);
              statusEl.textContent = "Erro ao ler o código. Tente novamente.";
            }
          });
        } catch (error) {
          console.error(error);
          statusEl.textContent = "Não foi possível acessar a câmera.";
          scanning = false;
          toggleBtn.textContent = "Iniciar leitura";
        }
      }

      function stopScanner() {
        if (codeReader) {
          codeReader.reset();
        }
        scanning = false;
        toggleBtn.textContent = "Iniciar leitura";
        statusEl.textContent = "Câmera parada";
      }

      function highlightInput(input) {
        input.classList.add("highlight");
        setTimeout(() => input.classList.remove("highlight"), 600);
      }

      cameraSelect.addEventListener("change", (event) => {
        currentDeviceId = event.target.value;
        if (scanning) {
          stopScanner();
          startScanner();
        }
      });

      toggleBtn.addEventListener("click", () => {
        if (scanning) {
          stopScanner();
        } else {
          startScanner();
        }
      });

      form.addEventListener("submit", (event) => {
        event.preventDefault();
        const data = new FormData(form);
        const payload = Object.fromEntries(data.entries());
        console.log("Produto pronto para salvar em IndexedDB", payload);
        alert("Produto pronto para ser salvo (persistência ainda não implementada).");
        form.reset();
      });

      window.addEventListener("load", initDevices);
    </script>
  </body>
</html>
